<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Log Splitter 4.0 (Enterprise Mode)</title>
    <style>
        body { font-family: sans-serif; padding: 30px; background: #f4f7f6; color: #333; line-height: 1.5; }
        .box { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        #drop-zone { border: 3px dashed #adc5cf; padding: 50px; text-align: center; border-radius: 10px; cursor: pointer; background: #fafafa; margin-bottom: 20px; }
        #drop-zone:hover { background: #edf7ff; border-color: #007bff; }
        .progress-container { margin: 20px 0; }
        .bar { height: 14px; background: #eee; border-radius: 7px; overflow: hidden; }
        .fill { width: 0%; height: 100%; background: #007bff; transition: width 0.1s; }
        .info { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .list { border-top: 1px solid #eee; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .file-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f1f1f1; }
        .dl-btn { background: #007bff; color: white; padding: 6px 14px; border-radius: 4px; text-decoration: none; font-size: 0.85em; }
        .warning { color: #d9534f; font-weight: bold; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="box">
    <h2>초대용량 로그 분할기 4.0</h2>
    <p class="info">512MB 문자열 제한을 우회하여 4GB+ 파일을 바이트 단위로 분석합니다.</p>
    
    <div id="drop-zone">파일을 여기에 드롭하거나 클릭하세요 (최대 용량 무제한)</div>
    <input type="file" id="file-input" style="display:none">

    <div class="progress-container">
        <div class="info" id="status-text">준비 완료</div>
        <div class="bar"><div class="fill" id="progress-fill"></div></div>
    </div>

    <div id="file-list" class="list"></div>
</div>

<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const progressFill = document.getElementById('progress-fill');
const statusText = document.getElementById('status-text');
const fileList = document.getElementById('file-list');

// 구분자 (UTF-8 바이트 배열)
const TARGET_TEXT = "모든 그룹에 대한 백테스트 완료";
const TARGET_BYTES = new TextEncoder().encode(TARGET_TEXT);

dropZone.onclick = () => fileInput.click();
fileInput.onchange = (e) => startProcessing(e.target.files[0]);

async function startProcessing(file) {
    if (!file) return;
    
    // UI 초기화
    fileList.innerHTML = '';
    let startOffset = 0;
    let currentPos = 0;
    let count = 0;
    
    // 청크 크기를 10MB로 작게 잡아 메모리 부하를 방지
    const CHUNK_SIZE = 10 * 1024 * 1024; 

    while (currentPos < file.size) {
        const slice = file.slice(currentPos, currentPos + CHUNK_SIZE + TARGET_BYTES.length);
        const buffer = await slice.arrayBuffer();
        const data = new Uint8Array(buffer);

        // 바이트 단위 고속 검색
        for (let i = 0; i <= data.length - TARGET_BYTES.length; i++) {
            let match = true;
            for (let j = 0; j < TARGET_BYTES.length; j++) {
                if (data[i + j] !== TARGET_BYTES[j]) {
                    match = false;
                    break;
                }
            }

            if (match) {
                const endOffset = currentPos + i + TARGET_BYTES.length;
                createDownloadItem(file, startOffset, endOffset, ++count);
                startOffset = endOffset;
                // 검색 포인터 이동
                i += TARGET_BYTES.length - 1;
            }
        }

        currentPos += CHUNK_SIZE;
        
        // 진행률 표시 및 UI 렌더링을 위한 강제 휴식 (중요!)
        const percent = ((currentPos / file.size) * 100).toFixed(1);
        progressFill.style.width = percent + '%';
        statusText.innerText = `분석 중... ${percent}% (발견: ${count}개)`;
        
        // 512MB 이상 문구가 안 나오면 경고 표시
        if (currentPos - startOffset > 600 * 1024 * 1024) {
            statusText.innerText = `주의: 현재 구간이 600MB를 넘었습니다. 검색 중...`;
        }

        // 브라우저에게 제어권을 넘겨 화면 멈춤 방지
        await new Promise(r => setTimeout(r, 0));
    }

    // 마지막 남은 부분 처리
    if (startOffset < file.size) {
        createDownloadItem(file, startOffset, file.size, ++count);
    }
    statusText.innerText = `완료! 총 ${count}개의 로그를 분할했습니다.`;
}

function createDownloadItem(file, start, end, index) {
    const size = end - start;
    if (size <= 0) return;

    // file.slice는 실제 메모리를 쓰지 않는 참조값임
    const blob = file.slice(start, end);
    const url = URL.createObjectURL(blob);
    const name = `part_${String(index).padStart(3, '0')}.log`;

    const div = document.createElement('div');
    div.className = 'file-card';
    div.innerHTML = `
        <div>
            <strong>${name}</strong> 
            <span style="font-size:0.8em; color:#999; margin-left:10px;">${(size / 1024 / 1024).toFixed(2)} MB</span>
            ${size > 500 * 1024 * 1024 ? '<br><span class="warning">⚠️ 이 파일은 매우 큽니다 (다운로드 시 브라우저가 느려질 수 있음)</span>' : ''}
        </div>
        <a href="${url}" download="${name}" class="dl-btn">다운로드</a>
    `;
    fileList.appendChild(div);
}
</script>

</body>
</html>
